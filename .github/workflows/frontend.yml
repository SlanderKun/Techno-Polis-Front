name: Frontend CI/CD

on:
  push:
    branches: ["master"]
  workflow_dispatch: {}

concurrency:
  group: deploy-frontend
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: technopolis-frontend
  DEPLOY_DIR: /opt/myapp/frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      owner_lower: ${{ steps.lower_owner.outputs.val }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Owner -> lowercase
        id: lower_owner
        shell: bash
        run: echo "val=${GITHUB_REPOSITORY_OWNER,,}" >> "$GITHUB_OUTPUT"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./app
          file: ./app/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.lower_owner.outputs.val }}/${{ env.FRONTEND_IMAGE }}:sha-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ steps.lower_owner.outputs.val }}/${{ env.FRONTEND_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ steps.lower_owner.outputs.val }}/${{ env.FRONTEND_IMAGE }}:buildcache,mode=max

      - name: Debug - image ref
        run: echo "IMAGE=${{ env.REGISTRY }}/${{ steps.lower_owner.outputs.val }}/${{ env.FRONTEND_IMAGE }}:sha-${{ github.sha }}"
  upload-backend-files:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Upload frontend project to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 158.160.201.116
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT != '' && secrets.SSH_PORT || '22' }}
          source: 
            - public
            - src
            - .env.example
            - docker-compose.yml
            - Dockerfile
            - eslint.config.js
            - index.html
            - nginx.conf
            - package-lock.json
            - package.json
            - tsconfig.app.json
            - tsconfig.json
            - tsconfig.node.json
            - vite.config.ts
          target: /opt/myapp/frontend
          overwrite: true
          strip_components: 0

  deploy:
    needs: upload-frontend-files
    runs-on: ubuntu-latest
    env:
      OWNER_LOWER: ${{ needs.build-and-push.outputs.owner_lower }}
      BACKEND_TAG: sha-${{ github.sha }}

    steps:
      - name: Remote deploy (frontend only)
        uses: appleboy/ssh-action@v1.2.0
        env:
          DEPLOY_DIR:     ${{ env.DEPLOY_DIR }}
          OWNER_LOWER:    ${{ env.OWNER_LOWER }}
          FRONTEND_TAG:    ${{ env.FRONTEND_TAG }}
          REGISTRY:       ${{ env.REGISTRY }}
          FRONTEND_IMAGE:  ${{ env.FRONTEND_IMAGE }}
          GHCR_USER:      ${{ secrets.GHCR_READ_USERNAME != '' && secrets.GHCR_READ_USERNAME || github.actor }}
          GHCR_TOKEN:     ${{ secrets.GHCR_READ_TOKEN    != '' && secrets.GHCR_READ_TOKEN    || secrets.GITHUB_TOKEN }}
        with:
          host: 158.160.201.116 
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT != '' && secrets.SSH_PORT || '22' }}
          envs: DEPLOY_DIR,OWNER_LOWER,FRONTEND_TAG,REGISTRY,FRONTEND_IMAGE,GHCR_USER,GHCR_TOKEN
          script: |
            set -euxo pipefail
            cd "$DEPLOY_DIR"
            echo "SERVER_DIR=$(pwd)"

            # GHCR login (на сервере обычно нужен PAT с read:packages)
            docker login "${REGISTRY}" -u "${GHCR_USER}" -p "${GHCR_TOKEN}" >/dev/null

            # deploy.env для фронта
            touch deploy.env
            sed -i '/^FRONTEND_OWNER=/d;/^FRONTEND_TAG=/d' deploy.env
            cat >> deploy.env <<EOF
            FRONTEND_OWNER=${OWNER_LOWER}
            FRONTEND_TAG=${FRONTEND_TAG}
            EOF
            echo "== deploy.env ==" && cat deploy.env

            docker network create shared-net || true
            docker compose -f docker-compose.yml build
            docker compose -f docker-compose.yml up -d

            
            # healthcheck
            set +e
            for u in http://localhost/ http://127.0.0.1/; do
              if curl -fsS "$u" >/dev/null 2>&1; then
                echo "OK: frontend is up at $u"
                exit 0
              fi
            done
            echo "Frontend healthcheck failed, dumping logs…"
            compose logs --no-color --tail=200 nginx || true
            compose logs --no-color --tail=200 frontend || true
            exit 1
